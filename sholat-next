#!/bin/bash

CFG="$HOME/.config/sholat/config"
CACHE_BASE="$HOME/.cache/sholat"
NOTIF_DIR="$CACHE_BASE/notified"

[[ -f "$CFG" ]] || { echo "Jalankan sholat-setup"; exit 0; }
source "$CFG"

TODAY=$(date +%Y-%m-%d)
YEAR_MONTH=$(date +%Y-%m)
NOW=$(date +%s)

CACHE_DIR="$CACHE_BASE/$YEAR_MONTH"
CACHE_FILE="$CACHE_DIR/$TODAY.json"

mkdir -p "$CACHE_DIR" "$NOTIF_DIR"

# ===============================
# FETCH HARIAN (ONLINE â†’ CACHE)
# ===============================
if [[ ! -f "$CACHE_FILE" ]]; then
  DATA=$(curl -fsS \
    --connect-timeout 2 --max-time 4 \
    "https://api.myquran.com/v2/sholat/jadwal/$CITY_ID/$TODAY" \
    2>/dev/null)

  if echo "$DATA" | jq -e '.status == true' >/dev/null 2>&1; then
    echo "$DATA" | jq '.data.jadwal
      | {subuh, terbit, dzuhur, ashar, maghrib, isya}' \
      > "$CACHE_FILE"
  fi
fi

# ===============================
# OFFLINE MODE
# ===============================
if [[ ! -f "$CACHE_FILE" ]]; then
  echo "â›” Jadwal belum tersedia"
  exit 0
fi

DATA=$(cat "$CACHE_FILE")

# ===============================
# PARSE JADWAL
# ===============================
declare -A prayers=(
  [Subuh]="$(jq -r '.subuh' <<< "$DATA")"
  [Terbit]="$(jq -r '.terbit' <<< "$DATA")"
  [Dzuhur]="$(jq -r '.dzuhur' <<< "$DATA")"
  [Ashar]="$(jq -r '.ashar' <<< "$DATA")"
  [Maghrib]="$(jq -r '.maghrib' <<< "$DATA")"
  [Isya]="$(jq -r '.isya' <<< "$DATA")"
)

# ===============================
# NOTIF TEPAT WAKTU SHOLAT
# ===============================
notify_sholat() {
  notify-send \
    --urgency=critical \
    --expire-time=0 \
    "ðŸ•Œ Waktu Sholat" \
    "Saatnya sholat $1 ($2)"
}

for name in Subuh Dzuhur Ashar Maghrib Isya; do
  t="${prayers[$name]}"
  ts=$(date -d "$TODAY $t" +%s 2>/dev/null) || continue

  flag="$NOTIF_DIR/$TODAY-$name"

  if [[ $NOW -ge $ts && ! -f "$flag" ]]; then
    notify_sholat "$name" "$t"
    touch "$flag"
  fi
done

# ===============================
# ESTIMASI SHOLAT TERDEKAT
# ===============================
for name in Subuh Terbit Dzuhur Ashar Maghrib Isya; do
  t="${prayers[$name]}"
  ts=$(date -d "$TODAY $t" +%s 2>/dev/null)

  [[ $ts -le $NOW ]] && continue

  diff=$((ts - NOW))
  jam=$((diff / 3600))
  menit=$(((diff % 3600) / 60))

  if [[ $jam -gt 0 ]]; then
    echo "$name â€¢ $jam jam $menit menit"
  else
    echo "$name â€¢ $menit menit"
  fi
  exit 0
done

echo "Semua sholat hari ini sudah lewat"
